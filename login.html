<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Gestion AÃ©roport</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="terminal">
        <div id="output">Airport Management System v1.0<br>Please log in.<br><br></div>

        <form id="loginForm">
            <div>
                <span>&gt; </span><label for="username">Username: </label>
                <input type="text" id="username" name="username" required autocomplete="off">
            </div>
            <div>
                <span>&gt; </span><label for="password">Password: </label>
                <input type="password" id="password" name="password" required autocomplete="off">
            </div>
            <br>
            <div>
                <button type="submit">Login</button>
            </div>
        </form>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const outputDiv = document.getElementById('output');
        const API_BASE_URL = 'http://127.0.0.1:8000';

        // Redirect to dashboard if already logged in
        if (sessionStorage.getItem('loggedInUser')) {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            redirectToDashboard(user.type);
        }

        function redirectToDashboard(userType) {
            switch (userType) {
                case 'pilote':
                    window.location.href = 'pilote_dashboard.html';
                    break;
                case 'agent':
                    window.location.href = 'agent_dashboard.html';
                    break;
                case 'gestionnaire':
                    window.location.href = 'gestionnaire_dashboard.html';
                    break;
            }
        }

        loginForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const username = loginForm.elements.username.value;
            const password = loginForm.elements.password.value;
            const requestBody = new URLSearchParams({ username, password });

            outputDiv.innerHTML += `&gt; Attempting login for user: ${username}...
`;

            try {
                const response = await fetch(`${API_BASE_URL}/login/`, { method: 'POST', body: requestBody });
                const data = await response.json();

                if (response.ok) {
                    outputDiv.innerHTML += `&gt; <span style="color: #00ff00;">SUCCESS:</span> Login successful!
`;
                    // Store access_token and token_type in sessionStorage
                    sessionStorage.setItem('access_token', data.access_token);
                    sessionStorage.setItem('token_type', data.token_type);

                    const loggedInUser = { id: data.user_id, type: data.user_type, name: username };

                    // Store user info in session storage
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));

                    // Redirect to appropriate dashboard
                    redirectToDashboard(data.user_type);
                } else {
                    outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERROR:</span> ${data.detail || 'Authentication failed'}

`;
                }
            } catch (error) {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">SYSTEM ERROR:</span> Could not connect to API.

`;
            }
            loginForm.elements.password.value = '';
        });
    </script>

</body>

</html>
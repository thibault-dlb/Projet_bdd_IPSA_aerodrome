<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voir les Créneaux - Gestion Aéroport</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="terminal">
    <div id="output"></div>
    
    <div id="view-container">
        <h2>Voir les Créneaux</h2>
        <div id="creneaux-list-viewer">
            <!-- Creneaux will be loaded here -->
        </div>
        <br>
        <button id="backToDashboard">Retour au Tableau de Bord</button>
    </div>
</div>

<script>
    const outputDiv = document.getElementById('output');
    const creneauxListViewerDiv = document.getElementById('creneaux-list-viewer');
    const backToDashboardButton = document.getElementById('backToDashboard');

    const API_BASE_URL = 'http://127.0.0.1:8000';

    let loggedInUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const userJson = sessionStorage.getItem('loggedInUser');
        if (!userJson) {
            window.location.href = 'login.html';
            return;
        }
        loggedInUser = JSON.parse(userJson);

        if (loggedInUser.type !== 'agent' && loggedInUser.type !== 'gestionnaire') {
            outputDiv.innerHTML = '<span style="color: #ff0000;">ACCÈS REFUSÉ:</span> Seuls les agents et gestionnaires peuvent voir les créneaux.';
            creneauxListViewerDiv.innerHTML = '';
            return;
        }

        await loadAllCreneaux();
    });

    backToDashboardButton.addEventListener('click', () => {
        window.location.href = 'agent_dashboard.html'; // Or gestionnaire_dashboard.html
    });

    async function loadAllCreneaux() {
        try {
            const token = sessionStorage.getItem('access_token');
            if (!token) {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> Token d'accès manquant. Redirection vers la connexion.
`;
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }

            const response = await fetch(`${API_BASE_URL}/creneaux/`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const creneaux = await response.json();

            if (response.ok) {
                if (creneaux.length === 0) {
                    creneauxListViewerDiv.innerHTML = '<p>Aucun créneau à afficher.</p>';
                    return;
                }
                creneauxListViewerDiv.innerHTML = '<table>' + 
                    '<thead><tr><th>ID</th><th>Pilote</th><th>Avion</th><th>Infrastructure</th><th>Début Prévu</th><th>Fin Prévue</th><th>État</th></tr></thead>' +
                    '<tbody>' +
                    creneaux.map(c => `
                        <tr>
                            <td>${c.Id}</td>
                            <td>${c.pilote_id}</td>
                            <td>${c.avion_id}</td>
                            <td>${c.infrastructure_id}</td>
                            <td>${c.debut_prevu}</td>
                            <td>${c.fin_prevu}</td>
                            <td>${c.etat}</td>
                        </tr>
                    `).join('') +
                    '</tbody></table>';

            } else {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> Impossible de charger les créneaux : ${creneaux.detail || response.statusText}
`;
            }
        } catch (error) {
            outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR SYSTÈME:</span> Impossible de connecter à l'API pour les créneaux.
`;
        }
    }
</script>

</body>
</html>

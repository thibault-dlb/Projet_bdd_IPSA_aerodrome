<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Cr√©neaux - Gestion A√©rodrome</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .creneau-card {
            background-color: #1a1a1a;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .creneau-header {
            font-size: 1.2em;
            color: #00ffff;
            margin-bottom: 10px;
        }

        .creneau-detail {
            margin: 5px 0;
            padding-left: 10px;
        }

        .etat-Demand√© {
            color: #ffff00;
        }

        .etat-Confirm√© {
            color: #00ffff;
        }

        .etat-Autoris√© {
            color: #00ff00;
        }

        .etat-Achev√© {
            color: #808080;
        }

        .etat-Annul√© {
            color: #ff0000;
        }

        .cout-highlight {
            color: #ffff00;
            font-weight: bold;
            font-size: 1.1em;
        }
    </style>
</head>

<body>

    <div id="terminal">
        <div id="output"></div>

        <div id="view-container">
            <h2>üìã Mes Cr√©neaux de Vol</h2>
            <div id="creneaux-list-viewer">
                <!-- Creneaux will be loaded here -->
            </div>
            <br>
            <button id="reserveNewButton">‚ûï R√©server un nouveau cr√©neau</button>
            <button id="backToDashboard">üîô Retour au Tableau de Bord</button>
        </div>
    </div>

    <script>
        const outputDiv = document.getElementById('output');
        const creneauxListViewerDiv = document.getElementById('creneaux-list-viewer');
        const backToDashboardButton = document.getElementById('backToDashboard');
        const reserveNewButton = document.getElementById('reserveNewButton');

        const API_BASE_URL = 'http://127.0.0.1:8000';

        let loggedInUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const userJson = sessionStorage.getItem('loggedInUser');
            if (!userJson) {
                window.location.href = 'login.html';
                return;
            }
            loggedInUser = JSON.parse(userJson);

            if (loggedInUser.type !== 'pilote') {
                outputDiv.innerHTML = '<span style="color: #ff0000;">ACC√àS REFUS√â:</span> Seuls les pilotes peuvent voir leurs cr√©neaux.';
                creneauxListViewerDiv.innerHTML = '';
                return;
            }

            await loadMyCreneaux();
        });

        backToDashboardButton.addEventListener('click', () => {
            window.location.href = 'pilote_dashboard.html';
        });

        reserveNewButton.addEventListener('click', () => {
            window.location.href = 'reserve_creneau.html';
        });

        async function loadMyCreneaux() {
            try {
                const token = sessionStorage.getItem('access_token');
                if (!token) {
                    outputDiv.innerHTML += `> <span style="color: #ff0000;">ERREUR:</span> Token d'acc√®s manquant. Redirection vers la connexion.
`;
                    setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                    return;
                }

                outputDiv.innerHTML = '> Chargement de vos cr√©neaux...\n';

                const response = await fetch(`${API_BASE_URL}/pilotes/me/creneaux/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const creneaux = await response.json();

                if (response.ok) {
                    outputDiv.innerHTML = `> <span style="color: #00ff00;">‚úÖ Cr√©neaux charg√©s:</span> ${creneaux.length} cr√©neau(x) trouv√©(s)\n`;

                    if (creneaux.length === 0) {
                        creneauxListViewerDiv.innerHTML = '<p style="color: #ffcc00;">Aucun cr√©neau enregistr√©. Cliquez sur "R√©server un nouveau cr√©neau" pour commencer.</p>';
                        return;
                    }

                    // Trier par date (plus r√©cents en premier)
                    creneaux.sort((a, b) => new Date(b.debut_prevu) - new Date(a.debut_prevu));

                    creneauxListViewerDiv.innerHTML = creneaux.map(c => {
                        const debut = new Date(c.debut_prevu);
                        const fin = new Date(c.fin_prevu);
                        const duree = ((fin - debut) / (1000 * 60)).toFixed(0); // en minutes

                        return `
                        <div class="creneau-card">
                            <div class="creneau-header">
                                ‚úàÔ∏è Cr√©neau #${c.Id} - <span class="etat-${c.etat}">${c.etat}</span>
                            </div>
                            <div class="creneau-detail">
                                üìÖ <strong>D√©but:</strong> ${debut.toLocaleString('fr-FR')}
                            </div>
                            <div class="creneau-detail">
                                üìÖ <strong>Fin:</strong> ${fin.toLocaleString('fr-FR')}
                            </div>
                            <div class="creneau-detail">
                                ‚è±Ô∏è <strong>Dur√©e:</strong> ${duree} minutes
                            </div>
                            <div class="creneau-detail">
                                üè¢ <strong>Infrastructure:</strong> ID ${c.infrastructure_id}
                            </div>
                            ${c.avion_id ? `<div class="creneau-detail">
                                ‚úàÔ∏è <strong>Avion:</strong> ${c.avion_id}
                            </div>` : ''}
                            <div class="creneau-detail cout-highlight">
                                üí∞ <strong>Co√ªt Total:</strong> ${c.cout_total ? c.cout_total.toFixed(2) + ' ‚Ç¨' : 'Non calcul√©'}
                            </div>
                            ${c.cout_total ? '<div class="creneau-detail" style="color: #00ff00; font-size: 0.9em;">‚ú® Calcul√© automatiquement par le syst√®me</div>' : ''}
                        </div>
                    `;
                    }).join('');

                } else {
                    outputDiv.innerHTML += `> <span style="color: #ff0000;">ERREUR:</span> Impossible de charger les cr√©neaux : ${creneaux.detail || response.statusText}
`;
                }
            } catch (error) {
                outputDiv.innerHTML += `> <span style="color: #ff0000;">ERREUR SYST√àME:</span> Impossible de connecter √† l'API pour les cr√©neaux.
`;
            }
        }
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©server un Cr√©neau</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="terminal">
    <div id="output"></div>
    
    <div id="reservation-container">
        <h2>R√©server un Cr√©neau</h2>
        <form id="creneauForm">
            <div>
                <label for="avion">Votre Avion:</label>
                <select id="avion" name="immatriculation" required></select>
            </div>
            <br>
            <div>
                <label for="infrastructure">Infrastructure:</label>
                <select id="infrastructure" name="infrastructure_id" required></select>
            </div>
            <br>
            <div>
                <label for="debut_prevu">D√©but Pr√©vu:</label>
                <input type="datetime-local" id="debut_prevu" name="debut_prevu" required>
            </div>
            <br>
            <div>
                <label for="fin_prevu">Fin Pr√©vue:</label>
                <input type="datetime-local" id="fin_prevu" name="fin_prevu" required>
            </div>
            <br>
            <button type="submit">R√©server le Cr√©neau</button>
        </form>
        <br>
        <button id="backToDashboard">Retour au Tableau de Bord</button>
    </div>
</div>

<script>
    const outputDiv = document.getElementById('output');
    const creneauForm = document.getElementById('creneauForm');
    const avionSelect = document.getElementById('avion');
    const infrastructureSelect = document.getElementById('infrastructure');
    const backToDashboardButton = document.getElementById('backToDashboard');

    const API_BASE_URL = 'http://127.0.0.1:8000';

    let loggedInUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const userJson = sessionStorage.getItem('loggedInUser');
        if (!userJson) {
            window.location.href = 'login.html';
            return;
        }
        loggedInUser = JSON.parse(userJson);

        if (loggedInUser.type !== 'pilote') {
            outputDiv.innerHTML = '<span style="color: #ff0000;">ACC√àS REFUS√â:</span> Seuls les pilotes peuvent r√©server des cr√©neaux.';
            creneauForm.style.display = 'none';
            return;
        }

        await fetchAvions();
        await fetchInfrastructures();
    });

    backToDashboardButton.addEventListener('click', () => {
        window.location.href = 'pilote_dashboard.html';
    });

    async function fetchAvions() {
        try {
            const token = sessionStorage.getItem('access_token'); // Assuming token is stored here
            if (!token) {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> Token d'acc√®s manquant. Redirection vers la connexion.
`;
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }

            const response = await fetch(`${API_BASE_URL}/pilotes/me/avions/`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const avions = await response.json();

            if (response.ok) {
                avionSelect.innerHTML = '';
                if (avions.length === 0) {
                    avionSelect.innerHTML = '<option value="">Aucun avion enregistr√©</option>';
                    outputDiv.innerHTML += `&gt; <span style="color: #ffcc00;">ATTENTION:</span> Aucun avion trouv√© pour ce pilote. Vous ne pouvez pas r√©server de cr√©neau.
`;
                    creneauForm.style.display = 'none';
                    return;
                }
                avions.forEach(avion => {
                    const option = document.createElement('option');
                    option.value = avion.Immatriculation;
                    option.textContent = `${avion.marque} ${avion.modele} (${avion.Immatriculation})`;
                    avionSelect.appendChild(option);
                });
            } else {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> Impossible de charger les avions : ${avions.detail || response.statusText}
`;
                creneauForm.style.display = 'none';
            }
        } catch (error) {
            outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR SYST√àME:</span> Impossible de connecter √† l'API pour les avions.
`;
            creneauForm.style.display = 'none';
        }
    }

    async function fetchInfrastructures() {
        try {
            // Infrastructures are generally public, but can be secured if needed
            const response = await fetch(`${API_BASE_URL}/infrastructures/`);
            const infrastructures = await response.json();

            if (response.ok) {
                infrastructureSelect.innerHTML = '';
                if (infrastructures.length === 0) {
                    infrastructureSelect.innerHTML = '<option value="">Aucune infrastructure disponible</option>';
                    outputDiv.innerHTML += `&gt; <span style="color: #ffcc00;">ATTENTION:</span> Aucune infrastructure n'est disponible.
`;
                    creneauForm.style.display = 'none';
                    return;
                }
                infrastructures.forEach(infra => {
                    const option = document.createElement('option');
                    option.value = infra.Id;
                    option.textContent = `${infra.nom} (${infra.type})`;
                    infrastructureSelect.appendChild(option);
                });
            } else {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> Impossible de charger les infrastructures : ${infrastructures.detail || response.statusText}
`;
                creneauForm.style.display = 'none';
            }
        } catch (error) {
            outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR SYST√àME:</span> Impossible de connecter √† l'API pour les infrastructures.
`;
            creneauForm.style.display = 'none';
        }
    }

    creneauForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const debutPrev = new Date(document.getElementById('debut_prevu').value);
        const finPrev = new Date(document.getElementById('fin_prevu').value);

        if (finPrev - debutPrev < 90 * 60 * 1000) { // 90 minutes in milliseconds
            outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> La dur√©e minimale d'un cr√©neau est de 90 minutes.
`;
            return;
        }

        const creneauData = {
            avion_id: avionSelect.value,
            infrastructure_id: parseInt(infrastructureSelect.value),
            debut_prevu: debutPrev.toISOString().slice(0, 19), // ISO format without Z
            fin_prevu: finPrev.toISOString().slice(0, 19),   // ISO format without Z
            etat: "Demand√©", // Added this line
            // pilote_id will be set by the backend from the token
            // cout_total will be set by the backend
        };
        
        outputDiv.innerHTML += `&gt; Tentative de r√©servation de cr√©neau...
`;

        try {
            const token = sessionStorage.getItem('access_token');
            if (!token) {
                outputDiv.innerHTML += `&gt; <span style="color: #ff0000;">ERREUR:</span> Token d'acc√®s manquant. Redirection vers la connexion.
`;
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }

                        const response = await fetch(`${API_BASE_URL}/creneaux/`, {

                            method: 'POST',

                            headers: {

                                'Content-Type': 'application/json',

                                'Authorization': `Bearer ${token}`

                            },

                            body: JSON.stringify(creneauData)

                        });

            

                        if (response.ok) {

                            const result = await response.json();

                            outputDiv.innerHTML += `> <span style="color: #00ff00;">‚úÖ SUCC√àS:</span> Cr√©neau r√©serv√© avec succ√®s!
> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
> <span style="color: #00ffff;">ID du Cr√©neau:</span> ${result.Id}
> <span style="color: #ffff00;">üí∞ Co√ªt Total Calcul√©:</span> ${result.cout_total ? result.cout_total.toFixed(2) + ' ‚Ç¨' : 'N/A'}
> <span style="color: #00ff00;">√âtat:</span> ${result.etat}
> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
> Le co√ªt a √©t√© <strong>calcul√© automatiquement</strong> par le syst√®me!
`;

                            creneauForm.reset(); // Clear the form

                                    } else {

                                        let errorBody;

                                        try {

                                            errorBody = await response.json();

                                        } catch (jsonError) {

                                            errorBody = await response.text();

                                        }

                        
                                        // ‚≠ê MISE EN √âVIDENCE DE L'ERREUR 90 MINUTES ‚≠ê
                                        let errorMessage = '';
                                        
                                        if (response.status === 409 && typeof errorBody === 'object' && errorBody.detail) {
                                            // C'est probablement l'erreur de la r√®gle des 90 minutes!
                                            errorMessage = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è  R√àGLE DES 90 MINUTES NON RESPECT√âE  ‚ö†Ô∏è
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${errorBody.detail}

Cette r√®gle de s√©curit√© garantit un intervalle
minimum de 90 minutes entre deux mouvements
sur la m√™me infrastructure.

üí° Veuillez choisir un autre cr√©neau horaire.
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
                                        } else {
                                            // Autre erreur
                                            errorMessage = `Erreur lors de la r√©servation du cr√©neau. Status: ${response.status}`;

                                            if (typeof errorBody === 'object' && errorBody !== null) {

                                                if (Array.isArray(errorBody.detail)) { // Check if detail is an array

                                                    errorMessage += ":\n" + errorBody.detail.map(err => {

                                                        return `${err.loc.join('.')} - ${err.msg}`;

                                                    }).join('\n');

                                                } else if (errorBody.detail) {

                                                    errorMessage += `: ${errorBody.detail}`;

                                                } else if (errorBody.message) {

                                                    errorMessage += `: ${errorBody.message}`;

                                                } else {

                                                    errorMessage += `: ${JSON.stringify(errorBody, null, 2)}`; // Pretty print for objects

                                                }

                                            } else if (typeof errorBody === 'string' && errorBody.length > 0) {

                                                errorMessage += `: ${errorBody}`;

                                            }
                                        }

                        

                                        outputDiv.innerHTML += `> <span style="color: #ff0000;">‚ùå ERREUR:</span> <pre>${errorMessage}</pre>

                        `; // Use <pre> for preformatted text, especially with newlines

                                    }

                    } catch (error) {

                        outputDiv.innerHTML += `> <span style="color: #ff0000;">ERREUR SYST√àME:</span> Impossible de connecter √† l'API pour la r√©servation de cr√©neau. D√©tails: ${error.message || error}

            `;

                    }
    });
</script>

</body>
</html>
